<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventprom System Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .loading { border-color: #ffc107; background: #fff3cd; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Ventprom System Test</h1>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã</p>

        <div class="test-section" id="api-health">
            <h3>1. API Health Check</h3>
            <button class="btn-primary" onclick="testApiHealth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API</button>
            <div id="health-result"></div>
        </div>

        <div class="test-section" id="presets-test">
            <h3>2. Presets API</h3>
            <button class="btn-primary" onclick="testPresets()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Presets</button>
            <div id="presets-result"></div>
        </div>

        <div class="test-section" id="parse-test">
            <h3>3. Parse API (Demo Data)</h3>
            <button class="btn-primary" onclick="testParseDemoData()">–¢–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞</button>
            <div id="parse-result"></div>
        </div>

        <div class="test-section" id="pack-test">
            <h3>4. Pack API</h3>
            <button class="btn-primary" onclick="testPacking()">–¢–µ—Å—Ç —É–ø–∞–∫–æ–≤–∫–∏</button>
            <div id="pack-result"></div>
        </div>

        <div class="test-section" id="export-test">
            <h3>5. Export API</h3>
            <button class="btn-primary" onclick="testExport()">–¢–µ—Å—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞</button>
            <div id="export-result"></div>
        </div>

        <div class="test-section" id="full-flow">
            <h3>6. –ü–æ–ª–Ω—ã–π Flow Test</h3>
            <button class="btn-success" onclick="testFullFlow()">–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç</button>
            <div id="full-result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';

        async function testApiHealth() {
            const resultDiv = document.getElementById('health-result');
            resultDiv.innerHTML = '<p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testPresets() {
            const resultDiv = document.getElementById('presets-result');
            resultDiv.innerHTML = '<p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/presets`);
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Presets —Ä–∞–±–æ—Ç–∞—é—Ç</h4>
                        <p>–ù–∞–π–¥–µ–Ω–æ ${data.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤:</p>
                        <ul>
                            ${data.map(v => `<li>${v.name} (${v.width}x${v.height}x${v.length}–º–º, ${v.maxPayloadKg}–∫–≥)</li>`).join('')}
                        </ul>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Presets –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testParseDemoData() {
            const resultDiv = document.getElementById('parse-result');
            resultDiv.innerHTML = '<p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</p>';
            
            try {
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const testData = 'id,type,w,h,length,qty,weight\\ntest1,rect,200,100,1000,2,15\\ntest2,round,150,,1200,1,12';
                const blob = new Blob([testData], { type: 'text/plain' });
                
                const formData = new FormData();
                formData.append('files', blob, 'test.csv');
                
                const response = await fetch(`${API_BASE}/parse`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç</h4>
                        <p>–ò–∑–≤–ª–µ—á–µ–Ω–æ ${data.items.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤:</p>
                        <pre>${JSON.stringify(data.items, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå –ü–∞—Ä—Å–∏–Ω–≥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testPacking() {
            const resultDiv = document.getElementById('pack-result');
            resultDiv.innerHTML = '<p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</p>';
            
            try {
                const testRequest = {
                    vehicle: {
                        id: 'gazelle',
                        name: '–ì–∞–∑–µ–ª—å',
                        width: 2000,
                        height: 1800,
                        length: 3000,
                        maxPayloadKg: 1500
                    },
                    items: [
                        {
                            id: 'test1',
                            type: 'rect',
                            w: 200,
                            h: 100,
                            length: 1000,
                            qty: 2,
                            weightKg: 15,
                            flangeType: 'TDC',
                            material: 'galvanized'
                        },
                        {
                            id: 'test2',
                            type: 'round',
                            d: 150,
                            length: 1200,
                            qty: 1,
                            weightKg: 12,
                            flangeType: 'NONE',
                            material: 'galvanized'
                        }
                    ]
                };
                
                const response = await fetch(`${API_BASE}/pack`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testRequest)
                });
                
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ –£–ø–∞–∫–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç</h4>
                        <p><strong>–£—Å–ø–µ—Ö:</strong> ${data.success}</p>
                        <p><strong>–í–µ—Å:</strong> ${data.totalWeight} –∫–≥</p>
                        <p><strong>–ó–∞–≥—Ä—É–∑–∫–∞:</strong> ${data.utilization.toFixed(1)}%</p>
                        <p><strong>–°—Ü–µ–Ω–∞—Ä–∏–π:</strong> ${data.scenario?.name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <details>
                            <summary>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå –£–ø–∞–∫–æ–≤–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testExport() {
            const resultDiv = document.getElementById('export-result');
            resultDiv.innerHTML = '<p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</p>';
            
            try {
                const testData = {
                    success: true,
                    items: [{ id: 'test', type: 'rect', w: 200, h: 100, length: 1000, qty: 1, weightKg: 15 }],
                    vehicle: { id: 'gazelle', name: '–ì–∞–∑–µ–ª—å', width: 2000, height: 1800, length: 3000, maxPayloadKg: 1500 },
                    totalWeight: 15,
                    utilization: 25.5,
                    message: 'Test export'
                };
                
                const response = await fetch(`${API_BASE}/export/html`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ packResult: testData })
                });
                
                if (response.ok) {
                    const html = await response.text();
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ HTML —ç–∫—Å–ø–æ—Ä—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç</h4>
                            <p>HTML —Ñ–∞–π–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (${html.length} —Å–∏–º–≤–æ–ª–æ–≤)</p>
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå –≠–∫—Å–ø–æ—Ä—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testFullFlow() {
            const resultDiv = document.getElementById('full-result');
            resultDiv.innerHTML = '<p>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç...</p>';
            
            let results = [];
            
            // 1. Health check
            try {
                await fetch(`${API_BASE}/api/health`);
                results.push('‚úÖ API Health');
            } catch {
                results.push('‚ùå API Health');
            }
            
            // 2. Presets
            try {
                const response = await fetch(`${API_BASE}/presets`);
                const data = await response.json();
                results.push(`‚úÖ Presets (${data.length} –º–∞—à–∏–Ω)`);
            } catch {
                results.push('‚ùå Presets');
            }
            
            // 3. Parse
            try {
                const testData = 'id,type,w,h,length,qty\\ntest,rect,200,100,1000,1';
                const blob = new Blob([testData], { type: 'text/plain' });
                const formData = new FormData();
                formData.append('files', blob, 'test.csv');
                
                const response = await fetch(`${API_BASE}/parse`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                results.push(`‚úÖ Parse (${data.items.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)`);
            } catch {
                results.push('‚ùå Parse');
            }
            
            // 4. Pack
            try {
                const testRequest = {
                    vehicle: { id: 'gazelle', name: '–ì–∞–∑–µ–ª—å', width: 2000, height: 1800, length: 3000, maxPayloadKg: 1500 },
                    items: [{ id: 'test', type: 'rect', w: 200, h: 100, length: 1000, qty: 1, weightKg: 15 }]
                };
                
                const response = await fetch(`${API_BASE}/pack`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testRequest)
                });
                const data = await response.json();
                results.push(`‚úÖ Pack (${data.success ? '—É—Å–ø–µ—à–Ω–æ' : '–æ—à–∏–±–∫–∞'})`);
            } catch {
                results.push('‚ùå Pack');
            }
            
            resultDiv.innerHTML = `
                <div class="${results.every(r => r.startsWith('‚úÖ')) ? 'success' : 'error'}">
                    <h4>üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:</h4>
                    <ul>
                        ${results.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${results.every(r => r.startsWith('‚úÖ')) ? 'üéâ –í–°–ï –†–ê–ë–û–¢–ê–ï–¢!' : '‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã'}</p>
                </div>
            `;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            setTimeout(() => {
                console.log('–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∞...');
                testFullFlow();
            }, 1000);
        };
    </script>
</body>
</html>
